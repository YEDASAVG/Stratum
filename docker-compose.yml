# LogAI Full Stack Docker Compose
# Run: docker compose up -d

services:
  # ============================================
  # Infrastructure Services
  # ============================================
  
  # Message Queue
  nats:
    image: nats:2.10-alpine
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # Monitoring/HTTP
    command: ["--jetstream", "--store_dir=/data", "-m", "8222"]
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Log Storage (ClickHouse)
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native client interface
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=logai
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Vector Database (Qdrant)
  qdrant:
    image: qdrant/qdrant:v1.15.0
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC interface
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================
  # Application Services
  # ============================================

  # API Server
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - RUST_LOG=info
      - NATS_URL=nats:4222
      - QDRANT_URL=http://qdrant:6334
      - CLICKHOUSE_URL=http://clickhouse:8123
      - LLM_PROVIDER=${LLM_PROVIDER:-groq}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}
      - LOGAI_MAX_CONTEXT_LOGS=${LOGAI_MAX_CONTEXT_LOGS:-25}
      - LOGAI_API_KEY=${LOGAI_API_KEY:-}
    command: ["./logai-api"]
    depends_on:
      nats:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Background Worker
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - RUST_LOG=info
      - NATS_URL=nats:4222
      - QDRANT_URL=http://qdrant:6334
      - CLICKHOUSE_URL=http://clickhouse:8123
    command: ["./logai-worker"]
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  # Log Simulator (generates sample logs)
  simulator:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - API_URL=http://api:3000
    command: ["./logai-simulate"]
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - demo  # Only runs with: docker compose --profile demo up

  # Dashboard (Next.js)
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3000/api
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

volumes:
  nats_data:
  clickhouse_data:
  qdrant_data:      
    